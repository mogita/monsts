stages:
  - deploy

before_script:
  - |
    if [ -z "$ENVIRONMENT" ]; then
      echo "ENVIRONMENT variable is not set. Pipeline failed."
      exit 1
    fi
  - |
    if [ -z "$CI_SERVER_NAME" ]; then
      echo "CI_SERVER_NAME variable is not set. Pipeline failed."
      exit 1
    fi
  - |
    if [ -z "$CI_LETSENCRYPT_EMAIL" ]; then
      echo "CI_LETSENCRYPT_EMAIL variable is not set. Pipeline failed."
      exit 1
    fi
  - apk add rsync openssh curl perl
  - mkdir -p ${CI_PROJECT_DIR}/elasticsearch-certs
  - cp $CI_SSL_KEY ${CI_PROJECT_DIR}/elasticsearch-certs/admin-key.pem
  - cp $CI_SSL_CERT ${CI_PROJECT_DIR}/elasticsearch-certs/admin.pem
  - cp $CI_SSL_CA ${CI_PROJECT_DIR}/elasticsearch-certs/root-ca.pem
  - |
    sed -i "s/server_name \$CI_SERVER_NAME/server_name $CI_SERVER_NAME/" ${CI_PROJECT_DIR}/nginx.conf
  - |
    perl -i -pe "BEGIN{undef $/;} s/\Q$CI_MASTODON_SECRETS\E/$(printf '%s' "$CI_MASTODON_SECRETS" | perl -pe 's/([\\$@%\/])/\\$1/g')/g" ${CI_PROJECT_DIR}/.env.production
  - |
    perl -i -pe "BEGIN{undef $/;} s/\Q$CI_MASTODON_WEB_PUSH_KEYS\E/$(printf '%s' "$CI_MASTODON_WEB_PUSH_KEYS" | perl -pe 's/([\\$@%\/])/\\$1/g')/g" ${CI_PROJECT_DIR}/.env.production
  - |
    perl -i -pe "BEGIN{undef $/;} s/\Q$CI_MASTODON_MAIL\E/$(printf '%s' "$CI_MASTODON_MAIL" | perl -pe 's/([\\$@%\/])/\\$1/g')/g" ${CI_PROJECT_DIR}/.env.production
  - |
    perl -i -pe "BEGIN{undef $/;} s/\Q$CI_MASTODON_FILE_STORAGE\E/$(printf '%s' "$CI_MASTODON_FILE_STORAGE" | perl -pe 's/([\\$@%\/])/\\$1/g')/g" ${CI_PROJECT_DIR}/.env.production

deploy:
  image: alpine
  stage: deploy
  variables:
    ENVIRONMENT: "*"
  environment:
    name: $ENVIRONMENT
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
  script:
    - mkdir -p ~/.ssh
    - echo "$CI_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
    # -I, --ignore-times don't skip files that match size and time
    - rsync -avI --exclude='.git/' --progress ./ $CI_REMOTE_USERNAME@$CI_REMOTE_HOST:$CI_REMOTE_PATH
    - ssh $CI_REMOTE_USERNAME@$CI_REMOTE_HOST "CI_PATH=$CI_REMOTE_PATH CI_SERVER_NAME=$CI_SERVER_NAME CI_LETSENCRYPT_EMAIL=$CI_LETSENCRYPT_EMAIL CI_ELASTIC_PASSWORD=$CI_ELASTIC_PASSWORD CI_POSTGRES_PASSWORD=$CI_POSTGRES_PASSWORD $CI_REMOTE_PATH/run.sh"
